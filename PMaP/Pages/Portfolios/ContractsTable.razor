@using System.Globalization
@using PMaP.Models.DBModels
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<ContractsTable> localizer

<div class="row">
    <div class="col-md-12 mts">
        <div id="tableTopScroll" style="overflow-x: auto; overflow-y: hidden; border: none 0px RED;" @onscroll="OnTopScroll">
            <div id="scrollTop" style="overflow-x: hidden; overflow-y: hidden; height:20px;"></div>
        </div>
        <div style="overflow-x: hidden; overflow-y: hidden; border: none 0px RED;">
            <div id="tableView" style="overflow-y: auto;" @onscroll="OnScroll">
                <table id="tableId" class="table table-striped table-bordered" style="background-color:#e6e6e6;">
                    <thead>
                        <tr class="heading" style="color:#336699;">
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Portfolio"))">@localizer["Portfolio"]</span>
                                <span class="fa @(GetContractsSortStyle("Portfolio"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Subportfolio"))">@localizer["Subportfolio"]</span>
                                <span class="fa @(GetContractsSortStyle("Subportfolio"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("ProcessDate"))">@localizer["ProcessDate"]</span>
                                <span class="fa @(GetContractsSortStyle("ProcessDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Id"))">@localizer["ContractID"]</span>
                                <span class="fa @(GetContractsSortStyle("Id"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("ContractType"))">@localizer["ContractType"]</span>
                                <span class="fa @(GetContractsSortStyle("ContractType"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("PerformingStatus"))">@localizer["PerformingStatus"]</span>
                                <span class="fa @(GetContractsSortStyle("PerformingStatus"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("DebtType"))">@localizer["DebtType"]</span>
                                <span class="fa @(GetContractsSortStyle("DebtType"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("MainParticipantId"))">@localizer["MainParticipantID"]</span>
                                <span class="fa @(GetContractsSortStyle("MainParticipantId"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("NumParticipants"))">@localizer["NumParticipants"]</span>
                                <span class="fa @(GetContractsSortStyle("NumParticipants"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("NumGuarantors"))">@localizer["NumGuarantors"]</span>
                                <span class="fa @(GetContractsSortStyle("NumGuarantors"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("OriginalEntity"))">@localizer["OriginalEntity"]</span>
                                <span class="fa @(GetContractsSortStyle("OriginalEntity"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("TotalAmountOb"))">@localizer["TotalAmountOB"]</span>
                                <span class="fa @(GetContractsSortStyle("TotalAmountOb"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Currency"))">@localizer["Currency"]</span>
                                <span class="fa @(GetContractsSortStyle("Currency"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("MaturityPrincipalBalance"))">@localizer["MaturityPrincipalBalance"]</span>
                                <span class="fa @(GetContractsSortStyle("MaturityPrincipalBalance"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("OutstandingPrincipalBalance"))">@localizer["OutstandingPrincipalBalance"]</span>
                                <span class="fa @(GetContractsSortStyle("OutstandingPrincipalBalance"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("OrdinaryInterests"))">@localizer["OrdinaryInterests"]</span>
                                <span class="fa @(GetContractsSortStyle("OrdinaryInterests"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("DefaultInterests"))">@localizer["DefaultInterests"]</span>
                                <span class="fa @(GetContractsSortStyle("DefaultInterests"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("OriginationDate"))">@localizer["OriginationDate"]</span>
                                <span class="fa @(GetContractsSortStyle("OriginationDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("MaturityDate"))">@localizer["MaturityDate"]</span>
                                <span class="fa @(GetContractsSortStyle("MaturityDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("EarlyMaturity"))">@localizer["EarlyMaturity"]</span>
                                <span class="fa @(GetContractsSortStyle("EarlyMaturity"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("EarlyMaturityDate"))">@localizer["EarlyMaturityDate"]</span>
                                <span class="fa @(GetContractsSortStyle("EarlyMaturityDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("FirstUnpaidInstalmentDate"))">@localizer["FirstUnpaidInstalmentDate"]</span>
                                <span class="fa @(GetContractsSortStyle("FirstUnpaidInstalmentDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("DefaultDate"))">@localizer["DefaultDate"]</span>
                                <span class="fa @(GetContractsSortStyle("DefaultDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("UnpaidInstalments"))">@localizer["UnpaidInstalments"]</span>
                                <span class="fa @(GetContractsSortStyle("UnpaidInstalments"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("OutstandingInstalments"))">@localizer["OutstandingInstalments"]</span>
                                <span class="fa @(GetContractsSortStyle("OutstandingInstalments"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("AccountingSituation"))">@localizer["AccountingSituation"]</span>
                                <span class="fa @(GetContractsSortStyle("AccountingSituation"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("LtvOriginal"))">@localizer["LTVOriginal"]</span>
                                <span class="fa @(GetContractsSortStyle("LtvOriginal"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Syndicated"))">@localizer["Syndicated"]</span>
                                <span class="fa @(GetContractsSortStyle("Syndicated"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("SyndicationPercent"))">@localizer["PercentOfSyndication"]</span>
                                <span class="fa @(GetContractsSortStyle("SyndicationPercent"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Securitized"))">@localizer["Securitized"]</span>
                                <span class="fa @(GetContractsSortStyle("Securitized"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("SecurityNumber"))">@localizer["SecurityNumber"]</span>
                                <span class="fa @(GetContractsSortStyle("SecurityNumber"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Novation"))">@localizer["Novation"]</span>
                                <span class="fa @(GetContractsSortStyle("Novation"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("NovationDate"))">@localizer["NovationDate"]</span>
                                <span class="fa @(GetContractsSortStyle("NovationDate"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("JudicialProcess"))">@localizer["JudicialProcess"]</span>
                                <span class="fa @(GetContractsSortStyle("JudicialProcess"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("ProceedingType"))">@localizer["ProceedingType"]</span>
                                <span class="fa @(GetContractsSortStyle("ProceedingType"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("LegalProcess"))">@localizer["LegalProcess"]</span>
                                <span class="fa @(GetContractsSortStyle("LegalProcess"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Insolvency"))">@localizer["Insolvency"]</span>
                                <span class="fa @(GetContractsSortStyle("Insolvency"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("Reo"))">@localizer["REO"]</span>
                                <span class="fa @(GetContractsSortStyle("Reo"))"></span>
                            </th>
                            <th>
                                <span class="sort-link" @onclick="@(() => SortContractsTable("ReoAmount"))">@localizer["REOAmount"]</span>
                                <span class="fa @(GetContractsSortStyle("ReoAmount"))"></span>
                            </th>
                            @if (isAdd == "0")
                            {
                                <th></th>
                                <th><input type="checkbox" disabled></th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (Contracts != null && Contracts.Count() > 0)
                        {
                            foreach (var item in Contracts)
                            {
                                string possitiveStyle = item.TotalAmountOb > 0 ? "background-color: #a9f7a9;" : "";
                                <tr style="@possitiveStyle">
                                    <td>@item.Portfolio</td>
                                    <td>@item.Subportfolio</td>
                                    <td>@(item.ProcessDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@item.Id</td>
                                    <td>@item.ContractType</td>
                                    <td>@item.PerformingStatus</td>
                                    <td>@item.DebtType</td>
                                    <td>@item.MainParticipantId</td>
                                    <td>@item.NumParticipants</td>
                                    <td>@item.NumGuarantors</td>
                                    <td>@item.OriginalEntity</td>
                                    <td>@(item.TotalAmountOb?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    <td>@item.Currency</td>
                                    <td>@(item.MaturityPrincipalBalance?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    <td>@(item.OutstandingPrincipalBalance?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    <td>@(item.OrdinaryInterests?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    <td>@(item.DefaultInterests?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    <td>@(item.OriginationDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@(item.MaturityDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@(item.EarlyMaturity == 1 ? "Yes" : "No")</td>
                                    <td>@(item.EarlyMaturityDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@(item.FirstUnpaidInstalmentDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@(item.DefaultDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@item.UnpaidInstalments</td>
                                    <td>@item.OutstandingInstalments</td>
                                    <td>@item.AccountingSituation</td>
                                    <td>@item.LtvOriginal</td>
                                    <td>@(item.Syndicated == 1 ? "Yes" : "No")</td>
                                    <td>@item.SyndicationPercent</td>
                                    <td>@(item.Securitized == 1 ? "Yes" : "No")</td>
                                    <td>@item.SecurityNumber</td>
                                    <td>@(item.Novation == 1 ? "Yes" : "No")</td>
                                    <td>@(item.NovationDate?.ToString("yyyy-MM-dd"))</td>
                                    <td>@(item.JudicialProcess == 1 ? "Yes" : "No")</td>
                                    <td>@item.ProceedingType</td>
                                    <td>@(item.LegalProcess == 1 ? "Yes" : "No")</td>
                                    <td>@item.Insolvency</td>
                                    <td>@(item.Reo == 1 ? "Yes" : "No")</td>
                                    <td>@(item.ReoAmount?.ToString("c", CultureInfo.CreateSpecificCulture("es-ES")))</td>
                                    @if (isAdd == "0")
                                    {
                                        <td>
                                            <button type="button" class="btn btn-xs btn-danger" @onclick="@(() => Remove(item))"><i class="fa fa-trash-o"></i></button>
                                        </td> 
                                        <td>
                                            <input type="checkbox" disabled>
                                        </td>
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>		
</div>

@code {
    [Parameter]
    public string isAdd { get; set; }
    [Parameter]
    public List<Contract> Contracts { get; set; }
    [Parameter]
    public EventCallback<Contract> OnRemoveContract { get; set; }

    private string currentContractsSortColumn;
    private bool isContractsSortedAscending;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setScrollTopWidth");
        }
    }

    private void SortContractsTable(string columnName)
    {
        var items = Contracts;

        if (columnName != currentContractsSortColumn)
        {
            items = items.OrderBy(x => x.GetType().GetProperty(columnName).GetValue(x, null)).ToList();
            currentContractsSortColumn = columnName;
            isContractsSortedAscending = true;
        }
        else
        {
            if (isContractsSortedAscending)
            {
                items = items.OrderByDescending(x => x.GetType().GetProperty(columnName).GetValue(x, null)).ToList();
            }
            else
            {
                items = items.OrderBy(x => x.GetType().GetProperty(columnName).GetValue(x, null)).ToList();
            }

            isContractsSortedAscending = !isContractsSortedAscending;
        }

        Contracts = items;

        StateHasChanged();
    }

    private string GetContractsSortStyle(string columnName)
    {
        if (currentContractsSortColumn != columnName)
        {
            return string.Empty;
        }
        if (isContractsSortedAscending)
        {
            return "fa-sort-up";
        }
        else
        {
            return "fa-sort-down";
        }
    }

    private Task Remove(Contract contract)
    {
        return OnRemoveContract.InvokeAsync(contract);
    }

    private async void OnTopScroll(EventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("onTopScroll");
    }

    private async void OnScroll(EventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("onScroll");
    }
}
